#!/bin/bash
# six-month-review.sh
#
# This script outputs ALL commit details (metadata, commit message, and full diff)
# for the current Git repository for a given date range and filtered by a specific author.
# The output is copied to the clipboard (using pbcopy on macOS) and written to a file.
#
# Usage:
#   ./six-month-review.sh --start-date <YYYY-MM-DD> --end-date <YYYY-MM-DD> --author "<author>"
#
# Example:
#   ./six-month-review.sh --start-date 2024-07-01 --end-date 2024-12-31 --author "Dan Garvey"

function usage() {
  echo "Usage: $0 --start-date <YYYY-MM-DD> --end-date <YYYY-MM-DD> --author \"<author>\""
  exit 1
}

# Parse command-line arguments (supporting both --arg value and --arg=value forms)
while [[ "$#" -gt 0 ]]; do
  case $1 in
    --start-date=*)
      START_DATE="${1#*=}"
      shift ;;
    --end-date=*)
      END_DATE="${1#*=}"
      shift ;;
    --author=*)
      AUTHOR="${1#*=}"
      shift ;;
    --start-date)
      START_DATE="$2"
      shift 2 ;;
    --end-date)
      END_DATE="$2"
      shift 2 ;;
    --author)
      AUTHOR="$2"
      shift 2 ;;
    *)
      echo "Unknown parameter: $1"
      usage ;;
  esac
done

if [[ -z "$START_DATE" || -z "$END_DATE" || -z "$AUTHOR" ]]; then
  usage
fi

# Ensure we're in a Git repository.
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "This is not a git repository."
  exit 1
fi

# Use a file on your Desktop as the output file.
OUTPUT_FILE="$HOME/Desktop/commits.txt"

# Check if the file exists and is writable; if not, try to create it.
if [ -f "$OUTPUT_FILE" ]; then
  if [ ! -w "$OUTPUT_FILE" ]; then
    echo "Permission denied: Cannot write to $OUTPUT_FILE. Check file permissions."
    exit 1
  fi
else
  touch "$OUTPUT_FILE" 2>/dev/null || { echo "Failed to create $OUTPUT_FILE. Check permissions."; exit 1; }
fi

{
  echo "## Local Commit History from ${START_DATE} to ${END_DATE}"
  echo "Filtered by author: ${AUTHOR}"
  echo ""
} > "${OUTPUT_FILE}"

# Output detailed commit information:
# --since and --until filter by date.
# --pretty=fuller prints full commit metadata.
# --patch includes the full diff for each commit.
git log --author="${AUTHOR}" --since="${START_DATE}" --until="${END_DATE}" --pretty=fuller  >> "${OUTPUT_FILE}"

echo "Output written to ${OUTPUT_FILE}${CLIP_MSG}."

# copy output to clipboard
pbcopy < "${OUTPUT_FILE}"
