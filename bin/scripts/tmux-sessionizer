#! /usr/bin/env bash

if [[ "$1" == "--worktrees" ]]; then
  extra_roots=()
  if [[ -n "$SESSIONIZER_EXTRA_DIRS" ]]; then
    IFS=' ' read -r -a extra_roots <<< "$SESSIONIZER_EXTRA_DIRS"
  fi

  shopt -s nullglob
  home_dirs=(~/*/)
  shopt -u nullglob
  search_dirs=("${home_dirs[@]}" ~/.dotfiles ~/me/*/ ~/work/*/)
  for root in "${extra_roots[@]}"; do
    search_dirs+=("$root"/*/)
  done
  shopt -u nullglob

  worktree_paths=()
  for dir in "${search_dirs[@]%/}"; do
    # Find git repos one level deep
    for repo in "$dir"/*/; do
      [[ -d "$repo/.git" ]] || continue
      while IFS= read -r line; do
        [[ "$line" == worktree* ]] && worktree_paths+=("${line#worktree }")
      done < <(git -C "$repo" worktree list --porcelain 2>/dev/null)
    done
    # Also check if dir itself is a git repo
    if [[ -d "$dir/.git" ]]; then
      while IFS= read -r line; do
        [[ "$line" == worktree* ]] && worktree_paths+=("${line#worktree }")
      done < <(git -C "$dir" worktree list --porcelain 2>/dev/null)
    fi
  done

  selected=$(printf '%s\n' "${worktree_paths[@]}" | sort -u | fzf --no-sort --tiebreak=index --height=40%)
  [ -z "$selected" ] && exit 0

  # Session name: <repo>_<branch> to avoid collisions
  repo_name=$(basename "$(git -C "$selected" rev-parse --show-toplevel 2>/dev/null)")
  branch=$(git -C "$selected" rev-parse --abbrev-ref HEAD 2>/dev/null | tr '/' '_')
  session_name="${repo_name}_${branch}"
  session_name=$(echo "$session_name" | tr . _)

  if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -s "$session_name" -c "$selected" -d
  fi

  tmux switch-client -t "$session_name"
  exit 0
fi

extra_roots=()
if [[ -n "$SESSIONIZER_EXTRA_DIRS" ]]; then
  IFS=' ' read -r -a extra_roots <<< "$SESSIONIZER_EXTRA_DIRS"
fi

shopt -s nullglob
home_dirs=(~/*/)
shopt -u nullglob
base_dirs=("${home_dirs[@]}" ~/.dotfiles ~/me/*/ ~/work/*/)
extra_dirs=()
for root in "${extra_roots[@]}"; do
  extra_dirs+=("$root"/*/)
done
dirs=("${base_dirs[@]}" "${extra_dirs[@]}")
shopt -u nullglob

existing_sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null)

session=$(
    {
        [ -n "$existing_sessions" ] && printf '%s\n' "$existing_sessions"
        printf '%s\n' "${dirs[@]%/}" \
            | grep -vE "/(Downloads|Documents|Music|Movies|Pictures|Desktop|Library|Public|Applications|Dropbox|\.Trash)"
    } | fzf --no-sort --tiebreak=index --height=40%
)

[ -z "$session" ] && exit 0

session_name=$(basename "$session")
for root in "${extra_roots[@]}"; do
  if [[ "$session" == "$root"/* ]]; then
    session_name="$(basename "$root")_$(basename "$session")"
    break
  fi
done
session_name=$(echo "$session_name" | tr . _)

if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -s "$session_name" -c "$session" -d
fi

tmux switch-client -t "$session_name"
