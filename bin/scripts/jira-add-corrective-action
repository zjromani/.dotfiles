#!/bin/bash

JIRA_URL="https://hotelengine.atlassian.net"
JIRA_USERNAME="${WORK_EMAIL}"
JIRA_API_TOKEN="${JIRA_API_TOKEN}"

PROJECT_KEY="BOOK"
ISSUE_TYPE="Corrective Action"
CUSTOM_FIELD_TYPE_ID="customfield_10045"
CUSTOM_FIELD_TYPE_VALUE="New Feature"  # Confirm this value in Jira if needed

SUMMARY=$1

if [ -z "$SUMMARY" ]; then
  echo "Usage: $0 <summary>"
  exit 1
fi

JSON_PAYLOAD=$(jq -n \
  --arg project_key "$PROJECT_KEY" \
  --arg issue_type "$ISSUE_TYPE" \
  --arg summary "$SUMMARY" \
  --arg type_id "$CUSTOM_FIELD_TYPE_ID" \
  --arg type_value "$CUSTOM_FIELD_TYPE_VALUE" \
  '
{
  fields: {
    project: { key: $project_key },
    issuetype: { name: $issue_type },
    summary: $summary,
    ($type_id): { value: $type_value }
  }
}')

echo "Creating Jira ticket with payload:"
echo "$JSON_PAYLOAD" | jq .

RESPONSE=$(curl -s -u "${JIRA_USERNAME}:${JIRA_API_TOKEN}" \
  -X POST \
  -H "Content-Type: application/json" \
  --data "$JSON_PAYLOAD" \
  "${JIRA_URL}/rest/api/2/issue")

if echo "$RESPONSE" | grep -q '"key"'; then
  ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key')
  echo "Corrective Action ticket created: $ISSUE_KEY"
  echo "Link: ${JIRA_URL}/browse/${ISSUE_KEY}"
  open "${JIRA_URL}/browse/${ISSUE_KEY}"
else
  echo "Failed to create ticket:"
  echo "$RESPONSE" | jq .
fi
