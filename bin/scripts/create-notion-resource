#!/bin/bash

source ~/.zshenv_private

NOTION_TOKEN="$NOTION_PROJECT_SECRET"
NOTION_RESOURCE_DATABASE_ID="${NOTION_RESOURCE_DATABASE_ID:?Error: NOTION_RESOURCE_DATABASE_ID not set}"

JSON_PAYLOAD=$(cat <<EOF
{
  "parent": { "database_id": "$NOTION_RESOURCE_DATABASE_ID" },
  "properties": {
    "Name": {
      "title": [
        {
          "text": {
            "content": ""
          }
        }
      ]
    }
  }
}
EOF
)

# Send the request to Notion's API to create a new page
RESPONSE=$(curl -s -X POST 'https://api.notion.com/v1/pages' \
  -H "Authorization: Bearer $NOTION_TOKEN" \
  -H "Content-Type: application/json" \
  -H "Notion-Version: 2022-06-28" \
  --data "$JSON_PAYLOAD")

echo "Response from Notion API:"
echo $RESPONSE

# Extract the URL from the API response and modify it for the Notion app
PAGE_URL=$(echo "$RESPONSE" | jq -r '.url' | sed 's/^https/notion/')

echo "Page URL:"
echo $PAGE_URL

# Check if the page creation was successful
if [ "$PAGE_URL" == "null" ]; then
  echo "Error: Failed to create document. Response from Notion:"
  echo $RESPONSE
  exit 1
fi

# Open the new page in the Notion app
open "$PAGE_URL"
