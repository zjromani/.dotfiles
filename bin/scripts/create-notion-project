#!/bin/bash

source ~/.zshenv_private

NOTION_TOKEN="$NOTION_PROJECT_SECRET"
NOTION_PROJECT_DATABASE_ID="${NOTION_PROJECT_DATABASE_ID:?Error: NOTION_PROJECT_DATABASE_ID not set}"

PROJECT_NAME="$1"
AREA_OF_FOCUS_WORK_ID="${NOTION_AREA_OF_FOCUS_ID:?Error: NOTION_AREA_OF_FOCUS_ID not set}"

JSON_PAYLOAD=$(cat <<EOF
{
  "parent": { "database_id": "$NOTION_PROJECT_DATABASE_ID" },
  "properties": {
    "Name": {
      "title": [
        {
          "text": {
            "content": "$PROJECT_NAME"
          }
        }
      ]
    },
    "Importance": {
      "select": {
        "name": "low"
      }
    }
  }
}
EOF
)

RESPONSE=$(curl -s -X POST 'https://api.notion.com/v1/pages' \
  -H "Authorization: Bearer $NOTION_TOKEN" \
  -H "Content-Type: application/json" \
  -H "Notion-Version: 2022-06-28" \
  --data "$JSON_PAYLOAD")

echo "response"
echo $RESPONSE

# grab the URL, replace it with notinn so we don't go to the browser but directly
# to the app.
PAGE_URL=$(echo "$RESPONSE" | jq -r '.url' | sed 's/^https/notion/')

echo "page url"
echo $PAGE_URL

if [ "$PAGE_URL" == "null" ]; then
  echo "Error: Failed to create project. Response from Notion:"
  echo $RESPONSE
  exit 1
fi

open "$PAGE_URL"

