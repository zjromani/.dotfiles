#!/usr/bin/env bash

DOTFILES_DIR="$HOME/.dotfiles"
CONFIG_DIR="$HOME/.config"
BIN_DIR="$DOTFILES_DIR/bin"
SCRIPTS_DIR="$BIN_DIR/scripts"

STOW_FOLDERS=("bin" "tmux" "zsh" "git" "nvim" "psql" "vim")

function check_stow_installed() {
    if ! command -v stow &> /dev/null; then
        echo "GNU Stow is not installed. Installing..."
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            sudo apt-get update && sudo apt-get install -y stow
        elif [[ "$OSTYPE" == "darwin"* ]]; then
            echo "Please install Stow using Homebrew:"
            echo "  brew install stow"
            exit 1
        fi
    else
        echo "GNU Stow is already installed."
    fi
}

check_stow_installed

# Change to DOTFILES_DIR
cd "$DOTFILES_DIR" || exit 1

# Backup existing .zshrc if it exists and is not a symlink
if [ -f "$HOME/.zshrc" ] && [ ! -L "$HOME/.zshrc" ]; then
    echo "Backing up existing .zshrc to .zshrc.backup"
    mv "$HOME/.zshrc" "$HOME/.zshrc.backup"
fi

# Stow each directory in the whitelist
echo "Stowing selected directories in $DOTFILES_DIR to $HOME..."
for folder in "${STOW_FOLDERS[@]}"; do
    if [ -d "$folder" ]; then
        echo "Stowing $folder..."
        stow "$folder"
    else
        echo "Warning: $folder does not exist in $DOTFILES_DIR"
    fi
done

# Add bin and scripts directories to PATH
echo "Adding bin and scripts directories to PATH..."
if [[ "$SHELL" == *"zsh"* ]]; then
    SHELL_RC="$HOME/.zshrc"
elif [[ "$SHELL" == *"bash"* ]]; then
    SHELL_RC="$HOME/.bashrc"
else
    SHELL_RC="$HOME/.profile"
fi

if ! grep -q "$BIN_DIR" "$SHELL_RC"; then
    echo "export PATH=\"\$PATH:$BIN_DIR\"" >> "$SHELL_RC"
    echo "Added $BIN_DIR to PATH in $SHELL_RC."
fi

if ! grep -q "$SCRIPTS_DIR" "$SHELL_RC"; then
    echo "export PATH=\"\$PATH:$SCRIPTS_DIR\"" >> "$SHELL_RC"
    echo "Added $SCRIPTS_DIR to PATH in $SHELL_RC."
fi

echo ""
echo "✅ Dotfiles setup complete!"
echo "ℹ️  Please restart your terminal session or run: exec \$SHELL"

